## Current Work Focus
-   **Implemented "Get Issue Type List" API in `backlog-project`**.
-   Implemented "Get Status List of Project" API in `backlog-project`.
-   Refactored `Status` model: defined a complete `Status` (`ProjectStatus`) in `backlog-project`, and updated `backlog-issue` to use it.
    -   Commonized test utility `setup_client` into `client::test_utils`.
    -   Implemented `get_project_status_list` MCP tool in `mcp-backlog-server`.
    -   Implemented `get_list_of_issue_attachments` API in `backlog-issue`.
    -   Implemented `get_issue_attachment_list` MCP tool in `mcp-backlog-server`.
    -   Implemented `get_attachment_file` (download issue attachment) API in `backlog-issue`.
    -   Implemented `blg issue download-attachment` CLI command.
    -   Implemented and then refined `download_issue_attachment_image` MCP tool in `mcp-backlog-server` (formerly `download_issue_attachment_file`).
    -   Implemented `download_issue_attachment_text` MCP tool in `mcp-backlog-server`.
    -   Implemented "Get List of Pull Request Attachments" API in `backlog-git` and `mcp-backlog-server`.
-   Implemented Pull Request Attachment Download functionality (library, CLI, MCP).
-   Refactored pull request number handling to use a newtype `PullRequestNumber(u64)` for improved type safety across the codebase.
-   Implemented `download_issue_attachment_raw` MCP tool.
-   Reorganized `mcp-backlog-server/README.md` to group tools by module.
-   Implemented `download_attachment` method in `backlog-document` crate (and refactored client for all downloads) to return filename, content type, and `bytes::Bytes`.
-   Implemented `download_document_attachment_image` MCP tool.
-   Refactored `client::Client::download_file_raw` to return `DownloadedFile` struct instead of a tuple, and updated all callers.
-   Refactored `ensure_image_type` in `mcp-backlog-server` to return `Result<(), McpError>`.
-   **Updated `backlog-document` Models and Schemars Integration**:
    -   **`backlog-document/src/models.rs`**:
        -   Added `attachments: Vec<DocumentAttachment>` to `DocumentDetail`.
        -   Defined new `DocumentAttachment` struct.
        -   Added `JsonSchema` derives to `Document`, `DocumentDetail`, `DocumentAttachment`, and `DocumentTag` (conditional on `schemars` feature).
        -   Corrected `status_id` in `DocumentDetail` to remain `i32` as per user clarification (it's document's own status, not project status).
    -   **`backlog-document/Cargo.toml`**: Added `schemars` optional dependency and a `schemars` feature: `schemars = ["dep:schemars", "backlog-core/schemars"]`.
    -   **`backlog-core/src/document_id.rs`**: Added `#[cfg_attr(feature = "schemars", derive(JsonSchema))]` to `DocumentId` struct and the `use schemars::JsonSchema;` import.
    -   **`backlog-api-client/Cargo.toml`**:
        -   Defined a general `schemars` feature to propagate to sub-crates: `schemars = ["backlog-core/schemars", "backlog-issue/schemars", ..., "backlog-document/schemars", ...]`.
        -   Corrected this feature list to remove propagation to `backlog-user` as it lacks a `schemars` feature.
    -   **`mcp-backlog-server/Cargo.toml`**: Enabled the new `schemars` feature for the `backlog-api-client` dependency.
    -   Verified all changes with `cargo check`, `cargo test`, `cargo clippy`, and `cargo fmt`.
-   **Implemented `get_document_tree` MCP Tool**:
    -   **`backlog-document` Models**: Added `JsonSchema` derives to `DocumentTreeNode` (in `models/tree_node.rs`) and `DocumentTreeResponse` (in `responses.rs`).
    -   **`mcp-backlog-server/src/document/request.rs`**: Defined `GetDocumentTreeRequest` struct.
    -   **`mcp-backlog-server/src/document/bridge.rs`**: Implemented `get_document_tree_tool` bridge function. Corrected import paths for `backlog_document` types to use `backlog_api_client` facade. Used direct struct instantiation for `GetDocumentTreeParams` as a workaround for a `derive_builder` issue.
    -   **`backlog-api-client/src/lib.rs`**: Ensured `DocumentTreeResponse` and `GetDocumentTreeParams` are re-exported under the `document` feature.
    -   **`mcp-backlog-server/src/server.rs`**: Added `get_document_tree` tool method.
    -   **`mcp-backlog-server/README.md`**: Documented the new tool.
    -   Verified all changes with `cargo check`, `test`, `clippy`, and `fmt`.

## Recent Changes
-   **Implemented "Get Issue Type List" API in `backlog-project`**:
    -   **`backlog-core/src/identifier.rs`**: Confirmed `IssueTypeId(u32)` already exists.
    -   **`backlog-project/src/models/issue_type.rs`**: Created new file and defined `IssueType` struct with fields: `id`, `project_id`, `name`, `color`, `display_order`, `template_summary`, `template_description`. Derived `Serialize`, `Deserialize`, `JsonSchema` (conditional).
    -   **`backlog-project/src/models/mod.rs`**: Exported `issue_type` module and `IssueType` struct.
    -   **`backlog-project/src/api/mod.rs`**:
        -   Added `get_issue_type_list(&self, project_id_or_key: impl Into<ProjectIdOrKey>) -> Result<Vec<IssueType>>` method to `ProjectApi`.
        -   Added unit tests for success (multiple items, empty list) and error (404) cases.
    -   **`backlog-project/src/lib.rs`**: Re-exported `IssueType` from `models`.
    -   **`backlog-api-client/src/lib.rs`**: Re-exported `IssueType` from `backlog_project` under the `project` feature.
    -   Verified all changes with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, `cargo clippy --all-features --all-targets`, and `cargo fmt --all`.
-   **Refactored Attachment Download Return Types and `ensure_image_type`**:
    -   **`client/src/client.rs`**:
        -   Defined `pub struct DownloadedFile { filename: String, content_type: String, bytes: bytes::Bytes }`.
        -   Changed `download_file_raw` to return `Result<DownloadedFile>`.
    -   **`client/src/lib.rs`**: Re-exported `DownloadedFile`.
    -   **`backlog-api-client/src/lib.rs`**: Re-exported `DownloadedFile` from the `client` crate.
    -   **Library Crate Updates (`backlog-issue`, `backlog-git`, `backlog-document`)**:
        -   Attachment download methods updated to return `Result<DownloadedFile>`.
        -   Unit tests updated.
        -   Unused `bytes` imports removed.
    -   **CLI Update (`backlog-api-client/src/bin/blg.rs`)**:
        -   Download handlers updated to use `DownloadedFile.bytes`.
    -   **MCP Server Bridge Functions (`mcp-backlog-server/.../bridge.rs`)**:
        -   Download bridge functions updated to return `Result<DownloadedFile>`.
        -   Unused `bytes` or `Bytes` imports removed.
    -   **`mcp-backlog-server/src/util.rs`**:
        -   Changed `ensure_image_type` to return `Result<(), McpError>`.
    -   **`mcp-backlog-server/src/server.rs`**:
        -   All download tool methods (`_raw`, `_image`, `_text`) updated to work with `DownloadedFile` from bridge functions and the new `ensure_image_type`.
    -   Verified all changes.
-   **Implemented Document Attachment Image Download (MCP Tool & Client/Library Refactor)**: (Details omitted for brevity, see previous context if needed)
    -   Verified all changes.

## Next Steps
-   Await further instructions from the user.

## Active Decisions & Considerations
-   **Model Ownership and Dependencies**:
    -   The canonical, complete status model (`ProjectStatus`) is now defined in `backlog-project` as statuses are project-level configurations.
    -   `backlog-issue` now depends on `backlog-project` to use this `ProjectStatus` for the `Issue.status` field. This reflects that an issue's status is one of the project-defined statuses.
    -   `IssueType` model is defined in `backlog-project` as it's a project-level configuration.
-   **MCP Server Structure**: New MCP tools related to a specific domain (e.g., "project") are organized into their own module within `mcp-backlog-server` (e.g., `src/project/`). This module typically contains `request.rs` for input structs and `bridge.rs` for the core logic interfacing with `backlog-api-client`.
-   **Test Utilities**: Common test helpers like `setup_client` are being centralized in the `client` crate's `test_utils` module, exposed via a feature flag, to reduce duplication across test suites in different crates.
-   **Facade Pattern Strength**: `backlog-api-client` continues to be the primary facade.
-   **Unified Error Handling**: `backlog_api_core::Error` (`ApiError`) remains central.

## Important Patterns & Preferences
-   **Centralized Facade (`backlog-api-client`)**.
-   **Consistent Error Propagation**.
-   **Builder Pattern for Request Params**.
-   Standard Rust project structure, workspace, feature flags, `thiserror`, `schemars`.
    -   **Model Placement**: Shared core types and identifiers (like `User`, `AttachmentId`, `PullRequestNumber`, `IssueTypeId`) in `backlog-core`. Domain-specific models in their respective crates.
    -   **Serialization of Newtypes**: For simple numeric newtypes like `PullRequestNumber(u64)` or existing `Id(u32)` types, deriving `Serialize` and `Deserialize` directly is sufficient for them to be treated as their inner numeric type in JSON. `#[serde(transparent)]` is an option for explicitness but not strictly necessary if the default behavior is as desired and consistent with project patterns.
    -   **Serialization of Structs**: Use `#[serde(rename_all = "camelCase")]` for structs that map to JSON objects to match Backlog API conventions. Use `#[serde(default, skip_serializing_if = "Option::is_none")]` for optional fields.
-   **MCP Tool Structure**: Tools in `mcp-backlog-server` are organized by domain into modules (e.g., `issue`, `git`, `project`). Each module typically contains:
    -   `request.rs`: Defines request structs deriving `serde::Deserialize` and `rmcp::schemars::JsonSchema` (using `use rmcp::schemars;`).
    -   `bridge.rs`: Contains functions that take these request structs and the `BacklogApiClient` (wrapped in `Arc<Mutex<>>`), perform the API call, and return a `crate::error::Result`.
    -   The main `server.rs` file then defines tool methods (annotated with `#[tool(...)]`) that call these bridge functions. Error conversion from `crate::error::Error` to `rmcp::Error` is handled by `impl From` and the `?` operator.
-   **Test Utilities**: Common test helpers like `setup_client` are centralized in the `client` crate's `test_utils` module, exposed via a feature flag.

## Learnings & Project Insights
-   Careful consideration of model ownership and inter-crate dependencies is crucial for maintaining a clean architecture, especially when types are shared or referenced across different API domains.
-   API documentation for embedded objects within larger responses (e.g., the `status` object within an `Issue`) must be checked to ensure local model definitions are complete and accurate. The `ProjectStatus` model is a good example of this.
    -   Centralizing test utilities improves maintainability and consistency of tests across the workspace.
    -   Compiler type inference, especially within closures or with generic traits like `Identifier`, can sometimes be surprising. Explicitly annotating types or casting (e.g., `att.id.value() as u64`) can be necessary to guide the compiler when its inference seems to contradict definitions. This was particularly noted during the PR attachment download implementation.
    -   For MCP tools returning generic binary data, if the `rmcp::model::Content` or `RawContent` enum doesn't offer a straightforward "raw binary" variant, returning a structured JSON object with base64-encoded data is a robust fallback (as done for `download_pull_request_attachment_raw`).
    -   When implementing `FromStr` for newtypes, ensure the error variant used (e.g., `crate::error::Error::InvalidParameter`) matches an actual defined variant in the error enum.
