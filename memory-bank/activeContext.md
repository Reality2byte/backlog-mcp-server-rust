## Current Work Focus
-   Implemented "Get Status List of Project" API in `backlog-project`.
-   Refactored `Status` model: defined a complete `Status` (`ProjectStatus`) in `backlog-project`, and updated `backlog-issue` to use it.
    -   Commonized test utility `setup_client` into `client::test_utils`.
    -   Implemented `get_project_status_list` MCP tool in `mcp-backlog-server`.
    -   Implemented `get_list_of_issue_attachments` API in `backlog-issue`.
    -   Implemented `get_issue_attachment_list` MCP tool in `mcp-backlog-server`.
    -   Implemented `get_attachment_file` (download issue attachment) API in `backlog-issue`.
    -   Implemented `blg issue download-attachment` CLI command.
    -   Implemented and then refined `download_issue_attachment_image` MCP tool in `mcp-backlog-server` (formerly `download_issue_attachment_file`).
    -   Implemented `download_issue_attachment_text` MCP tool in `mcp-backlog-server`.
    -   Implemented "Get List of Pull Request Attachments" API in `backlog-git` and `mcp-backlog-server`.
-   **Implemented Pull Request Attachment Download functionality (library, CLI, MCP)**.

## Recent Changes
-   **Implemented Pull Request Attachment Download (Library, CLI, MCP Tools)**:
    -   **`backlog-git/src/api.rs`**:
        -   Added `download_pull_request_attachment` method to `GitApi` to download attachment content as `bytes::Bytes`.
        -   Added unit tests for success and error cases.
        -   Corrected import for `backlog_api_core::bytes::Bytes` and ensured `backlog_core::Identifier` trait was in scope for `value()` method.
    -   **`backlog-api-client/src/bin/blg.rs`**:
        -   Added `pr download-attachment` subcommand to the CLI.
        -   Defined `DownloadPrAttachmentArgs` for arguments.
        -   Implemented logic to call the library function and save the downloaded file.
    -   **`mcp-backlog-server/src/git/request.rs`**:
        -   Defined `DownloadPullRequestAttachmentRequest` struct for the MCP tool.
    -   **`mcp-backlog-server/src/error.rs`**:
        -   Added `PullRequestAttachmentNotFound` variant to the local `Error` enum.
        -   Updated `From<Error> for McpError` to handle the new variant.
    -   **`mcp-backlog-server/src/git/bridge.rs`**:
        -   Implemented `download_pr_attachment_bridge` function. This bridge first fetches the attachment list to get the filename, then downloads the file content.
        -   Corrected `Identifier` trait import.
        -   Resolved a persistent type mismatch issue in ID comparison (`u32` vs `u64`) by ensuring both sides of the comparison were explicitly `u64`.
        -   Updated to use the new `Error::PullRequestAttachmentNotFound`.
    -   **`mcp-backlog-server/src/server.rs`**:
        -   Added three new MCP tools:
            -   `download_pull_request_attachment_raw`: Returns attachment metadata and base64-encoded content as JSON (fallback for generic raw binary).
            -   `download_pull_request_attachment_image`: Returns `Content::image` for image attachments.
            -   `download_pull_request_attachment_text`: Returns `Content::text` for UTF-8 text attachments.
        -   Corrected import and usage of `rmcp::model::RawContent` (ultimately removed direct usage for the `_raw` tool in favor of JSON).
    -   Verified all changes with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, `cargo clippy --all-features --all-targets`, and `cargo fmt --all`.
-   **Implemented "Get List of Pull Request Attachments" API and MCP Tool**:
    -   Defined `PullRequestAttachment` model in `backlog-git/src/models.rs`.
    -   Added `get_pull_request_attachment_list` method to `GitApi` in `backlog-git/src/api.rs` with unit tests.
    -   Added `schemars` feature and dev-dependencies (`wiremock`, `tokio`) to `backlog-git/Cargo.toml`.
    -   Exported `PullRequestAttachment` from `backlog-git/src/lib.rs`.
    -   Re-exported `PullRequestAttachment` from `backlog-api-client/src/lib.rs`.
    -   Defined `GetPullRequestAttachmentListRequest` in `mcp-backlog-server/src/git/request.rs`.
    -   Added `get_pull_request_attachment_list_tool` bridge function to `mcp-backlog-server/src/git/bridge.rs`.
    -   Added `get_pull_request_attachment_list` tool method to `Server` in `mcp-backlog-server/src/server.rs`.
    -   Verified with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, `cargo clippy --all-features --all-targets`, and `cargo fmt --all`.
-   **Implemented `download_issue_attachment_text` MCP Tool in `mcp-backlog-server`**:
    -   Added `download_issue_attachment_text` tool method to `Server` in `mcp-backlog-server/src/server.rs`.
    -   Reused `DownloadAttachmentRequest` and the existing `download_issue_attachment_file` bridge function.
    -   The method attempts to convert attachment bytes to a UTF-8 string.
    -   If successful, returns `Content::text(string_data)`.
    -   If UTF-8 conversion fails, returns an error indicating it's not a valid UTF-8 text file.
    -   Verified with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, `cargo clippy`, and `cargo fmt --all`.
-   **Refined MCP Tool for Image Attachment Download (`download_issue_attachment_image`)**:
    -   The existing `download_issue_attachment_file` MCP tool was renamed to `download_issue_attachment_image` by the user.
    -   The server method in `mcp-backlog-server/src/server.rs` was updated by the user to:
        -   Use `Content::image(base64_data, mime_type)` for the response, as discussed.
        -   Include a check to ensure the attachment's MIME type (obtained via `mime_guess`) starts with "image/". If not, it returns an error.
    -   The `use mime_guess;` statement was confirmed/added if necessary.
    -   The bridge function `download_issue_attachment_file` (which fetches filename and bytes) remained largely the same.
    -   The `DownloadAttachmentRequest` struct was reused.
    -   This refined error handling (rejecting non-images) was tested with issue PASTA-1242, which has non-image attachments, and the tool correctly returned an "Attachment is not an image" error.
-   **Implemented `blg issue download-attachment` CLI command**:
    -   Added `DownloadAttachment` variant to `IssueCommands` enum and `DownloadAttachmentArgs` struct in `backlog-api-client/src/bin/blg.rs`.
    -   Implemented logic to parse arguments, call the `get_attachment_file` API, and save the downloaded file.
    -   Updated `backlog-api-client/src/lib.rs` to re-export `AttachmentId`.
    -   Verified with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, and `cargo clippy`.
-   **Implemented `get_attachment_file` (Download Issue Attachment) API in `backlog-issue`**:
    -   Added `get_attachment_file` method to `IssueApi` in `backlog-issue/src/api/mod.rs`. This method takes `issue_id_or_key` and `attachment_id`, and returns `backlog_api_core::Result<backlog_api_core::bytes::Bytes>`.
    -   Added `download_file_raw` method to `client::Client` in `client/src/client.rs` to handle raw byte stream downloads.
    -   Updated `backlog-api-core/src/lib.rs` to re-export the `bytes` crate.
    -   Added `bytes` to workspace dependencies and `backlog-api-core` dependencies.
    -   Added `use backlog_core::Identifier;` in `backlog-issue/src/api/mod.rs` to bring the `value()` method for `AttachmentId` into scope.
    -   Added unit tests for `get_attachment_file`, covering success and 404 error cases.
    -   Verified with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, and `cargo clippy`.
-   **Implemented `get_issue_attachment_list` MCP Tool in `mcp-backlog-server`**:
    -   Defined `GetAttachmentListRequest` in `mcp-backlog-server/src/issue/request.rs`, using `rmcp::schemars` for `JsonSchema` derivation.
    -   Implemented `get_attachment_list_impl` bridge function in `mcp-backlog-server/src/issue/bridge.rs`.
    -   Added `get_issue_attachment_list` tool method to `Server` in `mcp-backlog-server/src/server.rs`.
    -   Updated `backlog-api-client/src/lib.rs` to re-export `Attachment`.
    -   Verified with `cargo check -p mcp-backlog-server --all-features`.
-   **Implemented `get_list_of_issue_attachments` API in `backlog-issue`**:
    -   Created `backlog-issue/src/models/attachment.rs` defining `Attachment` struct (using `backlog_core::identifier::AttachmentId`).
    -   Updated `backlog-issue/src/models/mod.rs` to export `Attachment`.
    -   Added `get_attachment_list` method to `IssueApi` in `backlog-issue/src/api/mod.rs`.
    -   Added unit tests for `get_attachment_list`.
    -   Updated `backlog-issue/src/lib.rs` to re-export `Attachment` and `Comment`.
    -   Updated `backlog-issue/Cargo.toml` to include `backlog-core/schemars` in its `schemars` feature.
-   **Implemented "Get Status List of Project" API & Refactored `Status` Model**:
    -   Added `schemars` as an optional dependency and feature to `backlog-project/Cargo.toml`.
    -   Defined a new, complete `Status` struct in `backlog-project/src/models/status.rs` (fields: `id`, `project_id`, `name`, `color`, `display_order`), deriving `Deserialize`, `Serialize`, and conditionally `JsonSchema`.
    -   Exported `Status` from `backlog-project`'s `models/mod.rs` and `lib.rs`.
    -   Added `backlog-project` as a dependency to `backlog-issue/Cargo.toml` and updated its `schemars` feature to also enable `backlog-project/schemars`.
    -   In `backlog-issue/src/models/issue.rs`:
        -   Removed the local, incomplete `Status` struct definition.
        -   Changed the `Issue.status` field to use `Box<backlog_project::Status>`.
        -   Updated imports to use `backlog_project::Status`.
        -   Removed unused `StatusId` import.
    -   Removed the re-export of the old `Status` from `backlog-issue/src/lib.rs`.
    -   Implemented `get_status_list` async method in `backlog-project/src/api/mod.rs` within `ProjectApi`.
    -   Added unit tests for `get_status_list` in `backlog-project/src/api/mod.rs`, including success, empty list, and error cases.
    -   Updated mock JSON in `backlog-issue` tests for `Issue.status` to provide the full `ProjectStatus` structure, fixing previous test failures.
    -   Re-exported `ProjectStatus` from `backlog-api-client/src/lib.rs` under the `project` feature.
-   **Implemented `get_project_status_list` MCP Tool**:
    -   Created a new `project` module in `mcp-backlog-server` (`src/project/mod.rs`).
    -   Defined `GetProjectStatusListRequest` in `mcp-backlog-server/src/project/request.rs`.
    -   Implemented `get_project_status_list_tool` function in `mcp-backlog-server/src/project/bridge.rs`.
    -   Registered the `project` module in `mcp-backlog-server/src/lib.rs`.
    -   Added the `get_project_status_list` tool method to `Server` in `mcp-backlog-server/src/server.rs`.
    -   Updated `mcp-backlog-server/Cargo.toml`:
        -   Enabled `project` feature for `backlog-api-client` dependency.
        -   Added `backlog-project` and `backlog-core` as direct dependencies.
        -   Added `schemars` as a direct dependency.
-   **Commonized Test Utility `setup_client`**:
    -   Added `test-utils` feature to `client/Cargo.toml`, enabling `wiremock` as an optional dependency.
    -   Created `client/src/test_utils.rs` and defined `pub async fn setup_client` there.
    -   Conditionally exported `test_utils` module from `client/src/lib.rs` via the `test-utils` feature.
    -   Updated `backlog-project/Cargo.toml` and `backlog-issue/Cargo.toml` to enable the `test-utils` feature for their `client` dependency.
    -   Updated test modules in `backlog-project` and `backlog-issue` to import and use `client::test_utils::setup_client`.
-   **Improved Error Handling for API Client and MCP Server** (Previous task):
    -   Enhanced `backlog_api_core::Error` with `HttpStatus` variant.
    -   Improved `client::Client` to parse structured Backlog API errors.
    -   Improved `mcp-backlog-server` error conversion.
-   **Implemented `get_issue_comments` MCP Tool** (Previous task).
-   **Established New Builder Pattern Convention** (Previous task).

## Next Steps
-   Await further instructions from the user.

## Active Decisions & Considerations
-   **Model Ownership and Dependencies**:
    -   The canonical, complete status model (`ProjectStatus`) is now defined in `backlog-project` as statuses are project-level configurations.
    -   `backlog-issue` now depends on `backlog-project` to use this `ProjectStatus` for the `Issue.status` field. This reflects that an issue's status is one of the project-defined statuses.
-   **MCP Server Structure**: New MCP tools related to a specific domain (e.g., "project") are organized into their own module within `mcp-backlog-server` (e.g., `src/project/`). This module typically contains `request.rs` for input structs and `bridge.rs` for the core logic interfacing with `backlog-api-client`.
-   **Test Utilities**: Common test helpers like `setup_client` are being centralized in the `client` crate's `test_utils` module, exposed via a feature flag, to reduce duplication across test suites in different crates.
-   **Facade Pattern Strength**: `backlog-api-client` continues to be the primary facade.
-   **Unified Error Handling**: `backlog_api_core::Error` (`ApiError`) remains central.

## Important Patterns & Preferences
-   **Centralized Facade (`backlog-api-client`)**.
-   **Consistent Error Propagation**.
-   **Builder Pattern for Request Params**.
-   Standard Rust project structure, workspace, feature flags, `thiserror`, `schemars`.
-   **Model Placement**: Shared core types in `backlog-core` (e.g., `User`, `AttachmentId`). Domain-specific models in their respective crates (e.g., `ProjectStatus` in `backlog-project`, `Attachment` in `backlog-issue`). If a model defined in one domain crate (e.g., `backlog-project::ProjectStatus`) is needed by another (e.g., `backlog-issue`), a direct dependency is added.
-   **MCP Tool Structure**: Tools in `mcp-backlog-server` are organized by domain into modules (e.g., `issue`, `git`, `project`). Each module typically contains:
    -   `request.rs`: Defines request structs deriving `serde::Deserialize` and `rmcp::schemars::JsonSchema` (using `use rmcp::schemars;`).
    -   `bridge.rs`: Contains functions that take these request structs and the `BacklogApiClient` (wrapped in `Arc<Mutex<>>`), perform the API call, and return a `crate::error::Result`.
    -   The main `server.rs` file then defines tool methods (annotated with `#[tool(...)]`) that call these bridge functions. Error conversion from `crate::error::Error` to `rmcp::Error` is handled by `impl From` and the `?` operator.
-   **Test Utilities**: Common test helpers like `setup_client` are centralized in the `client` crate's `test_utils` module, exposed via a feature flag.

## Learnings & Project Insights
-   Careful consideration of model ownership and inter-crate dependencies is crucial for maintaining a clean architecture, especially when types are shared or referenced across different API domains.
-   API documentation for embedded objects within larger responses (e.g., the `status` object within an `Issue`) must be checked to ensure local model definitions are complete and accurate. The `ProjectStatus` model is a good example of this.
    -   Centralizing test utilities improves maintainability and consistency of tests across the workspace.
    -   Compiler type inference, especially within closures or with generic traits like `Identifier`, can sometimes be surprising. Explicitly annotating types or casting (e.g., `att.id.value() as u64`) can be necessary to guide the compiler when its inference seems to contradict definitions.
    -   For MCP tools returning generic binary data, if the `rmcp::model::Content` or `RawContent` enum doesn't offer a straightforward "raw binary" variant, returning a structured JSON object with base64-encoded data is a robust fallback (as done for `download_pull_request_attachment_raw`).
