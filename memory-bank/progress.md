# Progress

## Current Status
-   **Memory Bank Initialized**: Core files created and populated.
-   **Project Structure Analyzed**.
-   **Dependencies Identified**.
-   **High-Level Code Structure Understood**.
-   **`mcp-backlog-server` Crate Exists**.
-   **Various API Endpoints Implemented**: `get_version_milestone_list`, `get_issues_by_milestone_name`, `update_issue`, Git/PR viewing, CLI issue commands, `get_comment_list`, `get_issue_comments` MCP tool.
-   **Refactoring and Code Quality**: `mcp-backlog-server` refactored, Clippy warnings addressed, code formatted.
-   **Comprehensive Error Handling & Dependency Refactoring ("100-Point Plan")**: Completed.
-   **Error Handling Enhancements**: Completed.
-   **"Get Status List of Project" API Implemented**:
    -   `Status` model defined in `backlog-project` with all fields (`id`, `project_id`, `name`, `color`, `display_order`).
    -   `backlog-issue` updated to use `backlog_project::Status` for `Issue.status`, removing its local incomplete `Status` definition. This involved adding a dependency `backlog-issue -> backlog-project`.
    -   `get_status_list` method implemented in `backlog-project::ProjectApi`.
    -   Unit tests added for `get_status_list`.
    -   `schemars` support added to `backlog-project` and `Status`.
    -   `backlog-api-client` updated to re-export `Status`.
-   **Test Utilities Commonized**:
    -   `setup_client` test helper moved to `client::test_utils` and made available via a `test-utils` feature in the `client` crate.
    -   Dependent crates (`backlog-project`, `backlog-issue`) updated to use this common helper and enable the feature.
-   **Verification**: All changes successfully verified with `cargo build --all-features`, `cargo clippy --all-features -- -D warnings`, and `cargo test --all-features --all-targets`.
-   **`get_project_status_list` MCP Tool Implemented**:
    -   New `project` module created in `mcp-backlog-server`.
    -   `GetProjectStatusListRequest` defined.
    -   `get_project_status_list_tool` bridge function implemented.
    -   Tool registered in `server.rs` and module in `lib.rs`.
    -   `mcp-backlog-server/Cargo.toml` updated with necessary dependencies and features.
    -   Verified with `cargo check -p mcp-backlog-server`.
-   **`get_list_of_issue_attachments` API Implemented in `backlog-issue`**:
    -   `Attachment` model defined in `backlog-issue/src/models/attachment.rs` using `backlog_core::identifier::AttachmentId`.
    -   `get_attachment_list` method added to `IssueApi`.
    -   Unit tests implemented and passed after fixes.
    -   Relevant modules and `Cargo.toml` updated.
    -   Verified with `cargo test -p backlog-issue --all-features`.
-   **`get_issue_attachment_list` MCP Tool Implemented in `mcp-backlog-server`**:
    -   `GetAttachmentListRequest` defined in `mcp-backlog-server/src/issue/request.rs`.
    -   `get_attachment_list_impl` bridge function implemented in `mcp-backlog-server/src/issue/bridge.rs`.
    -   Tool method added to `Server` in `mcp-backlog-server/src/server.rs`.
    -   `backlog-api-client/src/lib.rs` updated to re-export `Attachment`.
    -   Verified with `cargo check -p mcp-backlog-server --all-features`.
-   **`get_attachment_file` (Download Issue Attachment) API Implemented in `backlog-issue`**:
    -   Added `get_attachment_file` method to `IssueApi`.
    -   Added `download_file_raw` method to `client::Client`.
    -   Updated `backlog-api-core` to re-export `bytes` and added `bytes` as a workspace dependency.
    -   Added necessary imports and fixed compilation errors.
    -   Unit tests implemented for `get_attachment_file`.
    -   Verified with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, and `cargo clippy`.
-   **`blg issue download-attachment` CLI Command Implemented**:
    -   Added `DownloadAttachment` subcommand to `IssueCommands` in `blg.rs`.
    -   Defined `DownloadAttachmentArgs` for arguments: `issue_id_or_key`, `attachment_id`, `output`.
    -   Implemented logic to parse arguments, call the library function, and save the file using `tokio::fs::write`.
    -   Corrected import paths for `AttachmentId` in `blg.rs` and re-exported `AttachmentId` from `backlog-api-client` lib.
    -   Verified with `cargo check --all-targets --all-features`, `cargo test --all-features --all-targets`, and `cargo clippy`.
-   **`download_issue_attachment_image` MCP Tool Refined in `mcp-backlog-server`**:
    -   The tool (formerly `download_issue_attachment_file`) was renamed to `download_issue_attachment_image` by the user.
    -   The server method was updated by the user to use `Content::image` for the response.
    -   A check was added to ensure the attachment is an image based on its MIME type; an error is returned for non-image files.
    -   This error handling was successfully tested.
    -   Dependencies (`base64`, `mime_guess`) and import paths were confirmed/corrected.
-   **`download_issue_attachment_text` MCP Tool Implemented in `mcp-backlog-server`**:
    -   Added `download_issue_attachment_text` tool method to `Server`.
    -   Reused existing `DownloadAttachmentRequest` and `download_issue_attachment_file` bridge function.
    -   The method converts attachment bytes to a UTF-8 string. If successful, returns `Content::text`; otherwise, returns an error.
    -   Verified with all final verification commands.
-   **"Get List of Pull Request Attachments" API and MCP Tool Implemented**:
    -   Defined `PullRequestAttachment` model in `backlog-git`.
    -   Added `get_pull_request_attachment_list` method to `GitApi` with unit tests.
    -   Configured `backlog-git/Cargo.toml` with necessary features and dependencies.
    -   Re-exported `PullRequestAttachment` from `backlog-api-client`.
    -   Defined `GetPullRequestAttachmentListRequest` in `mcp-backlog-server`.
    -   Implemented `get_pull_request_attachment_list_tool` bridge function.
    -   Added `get_pull_request_attachment_list` tool method to `Server` in `mcp-backlog-server`.
    -   All changes verified with `cargo check`, `cargo test`, `cargo clippy`, and `cargo fmt`.
-   **Pull Request Attachment Download Implemented**: Added functionality to download pull request attachments in the library (`backlog-git`), CLI (`blg pr download-attachment`), and MCP server (`download_pull_request_attachment_raw/image/text` tools).
-   **`PrNumber` Newtype Refactoring**: Refactored pull request number handling to use `PrNumber(u64)` newtype for improved type safety across `backlog-core`, `backlog-git`, `backlog-api-client` (library and CLI), and `mcp-backlog-server`.
-   **`download_issue_attachment_raw` MCP Tool Implemented**: Added a new MCP tool to download issue attachments as raw (JSON with base64) data.
-   **`get_user_list` MCP Tool Implemented**: Added a new MCP tool to retrieve a list of all users in the Backlog space.
-   **`mcp-backlog-server/README.md` Reorganized**: Grouped the 'Available Tools' section by module for better clarity.

## What Works
-   The Memory Bank system is established and updated.
-   A baseline understanding of the project's architecture, technology stack, and purpose is documented.
-   **Unified Error Handling**: Consistent error handling via `backlog_api_core::Error`.
-   **Improved API Facade**: `backlog-api-client` acts as a strong facade.
-   **Simplified Consumer Dependencies**: `mcp-backlog-server` depends primarily on `backlog-api-client`.
-   The `backlog-api-client` library provides core functionality for Backlog API interaction, including:
    -   Git repository listing and details.
    -   Pull request listing, details, **attachment listing**, and **attachment download**.
    -   Issue listing, details, updates, comment listing, **attachment listing**, and **attachment file download**. (Issue status now uses a complete model from `backlog-project`).
    -   Document listing and details.
    -   Project listing, details, and **project status listing**.
    -   Space details.
    -   User details.
-   The `blg` CLI tool provides commands for various operations, including **downloading issue attachments** and **pull request attachments**.
-   The `mcp-backlog-server` provides a suite of MCP tools, including **project status listing**, **issue attachment listing**, **issue attachment image download** (using `Content::image`, rejecting non-images), **issue attachment text download** (using `Content::text`, rejecting non-UTF-8 files), **issue attachment raw download (JSON with base64 data)**, **pull request attachment download (raw JSON, image, text)**, and **user list retrieval**. Error reporting is informative.
-   The codebase is free of Clippy warnings and consistently formatted. All tests pass.
-   Test utilities like `setup_client` are now shared from the `client` crate.

## What's Left to Build (for this task)
-   "Get Status List of Project" feature implementation is complete.
-   `get_project_status_list` MCP tool implementation is complete.
-   Potential next steps, if requested:
    -   Integrate `get_status_list` into the `blg` CLI tool.
-   Complete full definitions for stubbed request parameter structs in `backlog-issue/src/requests/mod.rs`.

## Known Issues (from initialization process and ongoing work)
-   The `list_code_definition_names` tool did not find top-level definitions in the `src` directories of several module-specific crates.
-   The `download_attachment` method in `backlog-document/src/api.rs` is a placeholder.

## Evolution of Project Decisions
-   **Initial Project Setup**: Focused on creating the Backlog API client library and CLI.
-   (Previous items omitted for brevity - assume they are still relevant)
-   **`get_comment_list` Library Implementation**: User requested to implement issue comment retrieval.
-   **`get_issue_comments` MCP Tool Implementation**: User requested to implement an MCP tool to get issue comments.
-   **Error Handling Improvement**: Enhanced error handling in API client and MCP server.
-   **"Get Status List of Project" Implementation & `Status` Model Refactor**:
    -   User requested to add "Get Status List of Project" API to `backlog-project`.
    -   Discovered that the existing `Status` model in `backlog-issue` was incomplete compared to API responses for issue details.
    -   Decided to define a new, complete `Status` model (`ProjectStatus`) in `backlog-project` to represent project-level status definitions.
    -   Updated `backlog-issue` to depend on `backlog-project` and use `ProjectStatus` for the `Issue.status` field, ensuring data consistency.
    -   Commonized the `setup_client` test helper function into `client::test_utils` to be shared across test suites.
-   **`get_project_status_list` MCP Tool Implementation**:
    -   User requested to integrate the `get_status_list` library function into `mcp-backlog-server`.
    -   Created a new `project` module within `mcp-backlog-server` to house project-related tools.
    -   Implemented the `get_project_status_list` tool following established patterns for request structs, bridge functions, and server registration.
    -   Ensured error handling aligns with existing server patterns, using `?` for concise error propagation.
-   **`get_list_of_issue_attachments` API Implementation**:
    -   User requested to implement "Get List of Issue Attachments" API in `backlog-issue`.
    -   Defined `Attachment` model in `backlog-issue`, using `AttachmentId` from `backlog-core`.
    -   Implemented `get_attachment_list` in `IssueApi` with unit tests (initial test failures related to `IssueKey` parsing and `chrono` usage were fixed).
    -   Updated `Cargo.toml` for `backlog-issue` to ensure `backlog-core/schemars` feature propagation.
-   **`get_issue_attachment_list` MCP Tool Implementation**:
    -   User requested to add the `get_attachment_list` library function as an MCP tool.
    -   Defined `GetAttachmentListRequest` in `mcp-backlog-server` using `rmcp::schemars` convention.
    -   Implemented the bridge function and server method, ensuring correct error propagation.
    -   Updated `backlog-api-client` facade to re-export `Attachment` model.
    -   Corrected trait bound errors during `cargo check` by using `.clone()` for `IssueIdOrKey`.
-   **`get_attachment_file` (Download Issue Attachment) API Implementation**:
    -   User requested to implement "Get Issue Attachment" (download file) API in `backlog-issue`.
    -   Added `get_attachment_file` to `IssueApi`, returning `Result<bytes::Bytes>`.
    -   Added a new `download_file_raw` method to `client::Client` to support fetching raw byte streams.
    -   Ensured `bytes` crate is correctly re-exported by `backlog-api-core` and added as a workspace dependency.
    -   Resolved various compilation issues related to imports and method calls.
    -   Added unit tests for the new API method.
    -   Performed full workspace verification (`check`, `test`, `clippy`).
-   **`blg issue download-attachment` CLI Command Implementation**:
    -   User requested to add a CLI command to download issue attachments.
    -   Defined `clap` structures for the new subcommand `issue download-attachment` and its arguments (`issue_id_or_key`, `attachment_id`, `output`).
    -   Implemented the command logic in `blg.rs` to call the `get_attachment_file` library function and save the output.
    -   Corrected `AttachmentId` import paths in `blg.rs` and ensured it's re-exported from the `backlog-api-client` library facade.
    -   Verified with full workspace checks.
-   **`download_issue_attachment_image` MCP Tool Implementation and Refinement**:
    -   Initially, a generic `download_issue_attachment_file` MCP tool was implemented, returning a JSON object with base64 encoded data.
    -   The user then requested to specialize this for images, renaming it to `download_issue_attachment_image`.
    -   The user updated the server method to:
        -   Use `Content::image(base64_data, mime_type)` for the response.
        -   Add a check to ensure the MIME type indicates an image, returning an error otherwise.
    -   This refined behavior and error handling were successfully tested.
    -   Dependencies (`base64`, `mime_guess`) and necessary imports were confirmed.
-   **`download_issue_attachment_text` MCP Tool Implementation**:
    -   User requested a text-specific version of the attachment download tool.
    -   Added `download_issue_attachment_text` method to `mcp-backlog-server/src/server.rs`.
    -   It reuses the existing bridge function to get file bytes.
    -   It attempts to convert the bytes to a UTF-8 string. If successful, it returns `Content::text`. If conversion fails, it returns an error indicating the file is not valid UTF-8 text.
    -   This approach simplifies the logic by defining "text file" as "valid UTF-8" for the tool's purpose.
    -   Verified with all final verification commands.
-   **"Get List of Pull Request Attachments" API and MCP Tool Implementation**:
    -   User requested to implement "Get List of Pull Request Attachments" API.
    -   Defined `PullRequestAttachment` model in `backlog-git`.
    -   Implemented `get_pull_request_attachment_list` method in `GitApi` with unit tests.
    -   Added `schemars` feature and dev-dependencies to `backlog-git/Cargo.toml`.
    -   Re-exported `PullRequestAttachment` from `backlog-api-client`.
    -   Defined `GetPullRequestAttachmentListRequest` for MCP server.
    -   Implemented bridge function and server tool method in `mcp-backlog-server`.
    -   Corrected various compilation errors and warnings during implementation.
    -   Verified all changes with `cargo check`, `test`, `clippy`, and `fmt`.
-   **Pull Request Attachment Download Implementation**:
    -   User requested to implement download functionality for pull request attachments.
    -   Implemented `download_pull_request_attachment` method in `backlog-git::GitApi`.
    -   Added `blg pr download-attachment` command to the CLI.
    -   Added `DownloadPullRequestAttachmentRequest` to MCP server requests.
    -   Added `PullRequestAttachmentNotFound` error variant to MCP server errors.
    -   Implemented `download_pr_attachment_bridge` in MCP server, including logic to fetch filename first.
    -   Added `download_pull_request_attachment_raw` (returning JSON with base64 data), `_image`, and `_text` tools to MCP server.
    -   Resolved several compiler issues related to type inference (u32/u64 comparison) and `rmcp` content types during implementation.
    -   All changes verified with `cargo check`, `test`, `clippy`, and `fmt`.
-   **`PrNumber` Newtype Refactoring**:
    -   User requested to wrap `u64` pull request numbers with a `PrNumber(u64)` newtype for type safety.
    -   Defined `PrNumber` in `backlog-core` with necessary traits (`Identifier`, `Display`, `FromStr`, `Serialize`, `Deserialize`, etc.).
    -   Updated `backlog-git` (models and API methods), `backlog-api-client` (library facade and CLI tool), and `mcp-backlog-server` (bridge functions and error types) to use `PrNumber`.
    -   Ensured consistency with existing ID patterns (e.g., placement in `backlog-core`, `serde` derive without `transparent`).
    -   Resolved compiler errors related to `FromStr` error construction in `backlog-core`.
    -   All changes verified with `cargo check`, `test`, `clippy`, and `fmt`.
-   **`download_issue_attachment_raw` MCP Tool Implementation**:
    -   User requested a tool to download issue attachments as raw data, similar to the pull request raw download tool.
    -   Implemented `download_issue_attachment_raw` in `mcp-backlog-server/src/server.rs`.
    -   Reused existing `DownloadAttachmentRequest` and `issue::bridge::download_issue_attachment_file` bridge function.
    -   The tool returns a JSON object containing filename, MIME type, and base64-encoded data.
    -   Updated `mcp-backlog-server/README.md` to document the new tool.
    -   All changes verified with `cargo check`, `test`, `clippy`, and `fmt`.
-   **`get_user_list` MCP Tool Implementation**:
    -   User requested a tool to get a list of users.
    -   Added `get_user_list()` method to `backlog-user/src/api/mod.rs` (Backlog API for listing users takes no parameters).
    -   Created `user` module in `mcp-backlog-server` (`src/user/{mod,request,bridge}.rs`).
    -   Defined an empty `GetUserListRequest` in `src/user/request.rs`.
    -   Implemented `get_user_list_bridge` in `src/user/bridge.rs`.
    -   Added `get_user_list` tool method to `mcp-backlog-server/src/server.rs` and registered the `user` module in `mcp-backlog-server/src/lib.rs`.
    -   Enabled the `user` feature for the `backlog-api-client` dependency in `mcp-backlog-server/Cargo.toml`.
    -   Updated `mcp-backlog-server/README.md` to document the new tool.
    -   All changes verified with `cargo check`, `test`, `clippy`, and `fmt`.
-   **`mcp-backlog-server/README.md` Reorganization**:
    -   User requested to group the "Available Tools" section in `mcp-backlog-server/README.md` by the server's internal module structure (`document`, `git`, `issue`, `project`, `user`).
    -   Updated the README to reflect this new grouped structure.
    -   Corrected the tool name `list_pull_requests` to `get_pull_request_list` to match the actual implementation.
